// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  INFO_REQUESTED
  APPROVED
  DECLINED
  WITHDRAWN
}

enum GrantCycle {
  SPRING    // Feb 15 deadline
  FALL      // July 15 deadline
}

enum DocumentType {
  FORM_990
  FORM_990_EZ
  FORM_990_N
  FINANCIAL_STATEMENT
  AUDIT_REPORT
  PROJECT_NARRATIVE
  PROJECT_BUDGET
  BOARD_LIST
  IRS_DETERMINATION
  ANNUAL_REPORT
  OTHER
}

enum DocumentScope {
  ORGANIZATION  // Stored in org document library
  APPLICATION   // Specific to an application
}

// ============================================
// USER & ORGANIZATION MODELS
// ============================================

model User {
  id                    String   @id @default(cuid())
  clerkId               String   @unique
  email                 String   @unique
  firstName             String?
  lastName              String?
  phone                 String?
  title                 String?
  
  // Relationship to organization (for applicants)
  organizationId        String?
  organization          Organization? @relation(fields: [organizationId], references: [id])
  
  // Preferences
  emailNotifications    Boolean  @default(true)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  lastLoginAt           DateTime?
  
  @@index([clerkId])
  @@index([organizationId])
}

model Organization {
  id                    String   @id @default(cuid())
  
  // Basic Information
  legalName             String
  dbaName               String?
  ein                   String   @unique
  
  // Address
  address               String
  addressLine2          String?
  city                  String
  state                 String
  zipCode               String
  
  // Contact
  phone                 String
  website               String?
  
  // Organization Details
  yearFounded           Int?
  missionStatement      String   @db.Text
  
  // Tax Status
  is501c3               Boolean  @default(true)
  taxExemptSince        DateTime?
  irsSubsection         String?  // e.g., "501(c)(3)"
  
  // Leadership
  executiveDirectorName String?
  executiveDirectorEmail String?
  executiveDirectorPhone String?
  
  // Organizational Capacity
  fullTimeStaff         Int?
  partTimeStaff         Int?
  volunteers            Int?
  boardMembers          Int?
  
  // Financial
  annualBudget          Decimal? @db.Decimal(12, 2)
  fiscalYearEnd         String?  // e.g., "December 31"
  
  // Form 990 Data (extracted/entered)
  form990Year           Int?
  form990TotalRevenue   Decimal? @db.Decimal(12, 2)
  form990TotalExpenses  Decimal? @db.Decimal(12, 2)
  form990NetAssets      Decimal? @db.Decimal(12, 2)
  form990ProgramExpenses Decimal? @db.Decimal(12, 2)
  form990AdminExpenses  Decimal? @db.Decimal(12, 2)
  form990FundraisingExpenses Decimal? @db.Decimal(12, 2)
  
  // Profile Completion
  profileComplete       Boolean  @default(false)
  profileCompletedAt    DateTime?
  
  // Relationships
  users                 User[]
  documents             Document[]
  applications          Application[]
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([ein])
  @@index([legalName])
}

// ============================================
// DOCUMENT LIBRARY
// ============================================

model Document {
  id                    String       @id @default(cuid())
  
  // Ownership
  organizationId        String?
  organization          Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  applicationId         String?
  application           Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  // Document Info
  scope                 DocumentScope
  type                  DocumentType
  name                  String       // User-friendly name
  description           String?
  
  // File Details
  fileName              String
  fileSize              Int
  mimeType              String
  storageKey            String       // Blob/S3 key
  storageUrl            String       // URL (regenerated for private)
  
  // Metadata
  documentYear          Int?         // For Form 990, financials
  expiresAt             DateTime?    // For time-sensitive docs
  
  // Audit
  uploadedById          String       // Clerk user ID
  uploadedByName        String
  uploadedAt            DateTime     @default(now())
  
  @@index([organizationId])
  @@index([applicationId])
  @@index([type])
}

// ============================================
// APPLICATION MODELS
// ============================================

model Application {
  id                    String            @id @default(cuid())
  
  // Relationships
  organizationId        String
  organization          Organization      @relation(fields: [organizationId], references: [id])
  
  // Application Metadata
  grantCycle            GrantCycle
  cycleYear             Int
  status                ApplicationStatus @default(DRAFT)
  submittedAt           DateTime?
  
  // Submission tracking
  submittedById         String?           // Clerk user ID
  submittedByName       String?
  
  // Project Details
  projectTitle          String?
  projectDescription    String?           @db.Text
  projectGoals          String?           @db.Text
  targetPopulation      String?           @db.Text
  geographicArea        String?
  projectStartDate      DateTime?
  projectEndDate        DateTime?
  
  // Funding Request
  amountRequested       Decimal?          @db.Decimal(10, 2)
  totalProjectBudget    Decimal?          @db.Decimal(10, 2)
  percentageRequested   Decimal?          @db.Decimal(5, 2) // Auto-calculated
  otherFundingSources   String?           @db.Text
  previousHFFGrants     String?           @db.Text
  
  // Impact & Outcomes
  expectedOutcomes      String?           @db.Text
  measurementPlan       String?           @db.Text
  sustainabilityPlan    String?           @db.Text
  beneficiariesCount    Int?
  
  // Children Focus (Mission Alignment)
  childrenServed        Int?
  ageRangeStart         Int?
  ageRangeEnd           Int?
  povertyIndicators     String?           @db.Text
  schoolsServed         String?           @db.Text
  
  // Budget Breakdown (JSON for flexibility)
  budgetBreakdown       Json?
  
  // Application Progress (for multi-step form)
  currentStep           Int               @default(1)
  completedSteps        Int[]             @default([])
  lastSavedAt           DateTime?
  
  // AI-Generated Content
  aiSummary             String?           @db.Text
  aiSummaryGeneratedAt  DateTime?
  aiMissionAlignment    Int?              // 1-100 score
  aiBudgetAnalysis      Json?
  aiStrengths           String[]          @default([])
  aiConcerns            String[]          @default([])
  aiQuestions           String[]          @default([])
  
  // Related Data
  documents             Document[]
  notes                 Note[]
  statusHistory         StatusHistory[]
  communications        Communication[]
  
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  @@index([status])
  @@index([grantCycle, cycleYear])
  @@index([organizationId])
  @@index([submittedAt])
}

model Note {
  id                    String      @id @default(cuid())
  applicationId         String
  application           Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  authorId              String      // Clerk user ID
  authorName            String
  content               String      @db.Text
  isPrivate             Boolean     @default(true) // Private = staff only
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([applicationId])
}

model StatusHistory {
  id                    String            @id @default(cuid())
  applicationId         String
  application           Application       @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  previousStatus        ApplicationStatus?
  newStatus             ApplicationStatus
  changedById           String?           // Clerk user ID (null for system)
  changedByName         String?
  reason                String?           @db.Text
  
  createdAt             DateTime          @default(now())
  
  @@index([applicationId])
}

model Communication {
  id                    String      @id @default(cuid())
  applicationId         String
  application           Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  direction             String      // 'inbound' | 'outbound'
  type                  String      // 'email' | 'portal_message' | 'system'
  subject               String?
  content               String      @db.Text
  
  sentById              String?     // Clerk user ID
  sentByName            String?
  sentAt                DateTime    @default(now())
  
  // For info requests
  responseRequired      Boolean     @default(false)
  responseDeadline      DateTime?
  responseReceivedAt    DateTime?
  responseContent       String?     @db.Text
  
  @@index([applicationId])
  @@index([responseRequired, responseReceivedAt])
}

// ============================================
// SYSTEM CONFIGURATION
// ============================================

model GrantCycleConfig {
  id                    String     @id @default(cuid())
  cycle                 GrantCycle
  year                  Int
  
  // Dates
  loiOpenDate           DateTime?
  loiDeadline           DateTime
  fullAppDeadline       DateTime?
  reviewStartDate       DateTime?
  decisionDate          DateTime?
  
  // Status
  isActive              Boolean    @default(false)
  acceptingApplications Boolean    @default(false)
  
  // Settings
  maxRequestAmount      Decimal?   @db.Decimal(10, 2)
  
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
  
  @@unique([cycle, year])
}

model EmailTemplate {
  id                    String   @id @default(cuid())
  name                  String   @unique
  subject               String
  body                  String   @db.Text
  variables             String[] // Available merge fields
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model AuditLog {
  id                    String   @id @default(cuid())
  userId                String?  // Clerk user ID
  userEmail             String?
  userType              String?  // 'applicant' | 'reviewer' | 'admin' | 'system'
  action                String
  entityType            String
  entityId              String?
  details               Json?
  ipAddress             String?
  
  createdAt             DateTime @default(now())
  
  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
}
