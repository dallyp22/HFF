// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  INFO_REQUESTED
  APPROVED
  DECLINED
  WITHDRAWN
}

enum GrantCycle {
  SPRING    // Feb 15 deadline
  FALL      // July 15 deadline
}

enum DocumentType {
  FORM_990
  FORM_990_EZ
  FORM_990_N
  FINANCIAL_STATEMENT
  AUDIT_REPORT
  PROJECT_NARRATIVE
  PROJECT_BUDGET
  BOARD_LIST
  IRS_DETERMINATION
  ANNUAL_REPORT
  ANNUAL_ORG_BUDGET
  END_OF_YEAR_FINANCIAL
  PROJECT_PHOTO
  OTHER
}

enum DocumentScope {
  ORGANIZATION  // Stored in org document library
  APPLICATION   // Specific to an application
  LOI           // Specific to a Letter of Interest
}

// ============================================
// LOI ENUMS
// ============================================

enum LOIStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  DECLINED
  WITHDRAWN
}

enum FocusArea {
  HUMAN_HEALTH
  EDUCATION
  COMMUNITY_WELLBEING
}

enum ExpenditureType {
  PROGRAMMING       // Programming/Special Project
  OPERATING         // Operating Funding
  CAPITAL           // Capital Project (requires pre-approval)
}

enum GeographyServed {
  OMAHA_COUNCIL_BLUFFS
  WESTERN_IOWA_100_MILES
  OTHER
}

// ============================================
// USER & ORGANIZATION MODELS
// ============================================

model User {
  id                    String   @id @default(cuid())
  clerkId               String   @unique
  email                 String   @unique
  firstName             String?
  lastName              String?
  phone                 String?
  title                 String?
  
  // Relationship to organization (for applicants)
  organizationId        String?
  organization          Organization? @relation(fields: [organizationId], references: [id])
  
  // Preferences
  emailNotifications    Boolean  @default(true)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  lastLoginAt           DateTime?
  
  @@index([clerkId])
  @@index([organizationId])
}

model Organization {
  id                    String   @id @default(cuid())
  
  // Basic Information
  legalName             String
  dbaName               String?
  ein                   String   @unique
  
  // Address
  address               String
  addressLine2          String?
  city                  String
  state                 String
  zipCode               String
  
  // Contact
  phone                 String
  website               String?
  
  // Organization Details
  yearFounded           Int?
  missionStatement      String   @db.Text
  
  // Tax Status
  is501c3               Boolean  @default(true)
  taxExemptSince        DateTime?
  irsSubsection         String?  // e.g., "501(c)(3)"
  
  // Leadership
  executiveDirectorName String?
  executiveDirectorEmail String?
  executiveDirectorPhone String?

  // Secondary Contact (Development Director / Grants Contact)
  devDirectorName       String?
  devDirectorEmail      String?
  devDirectorPhone      String?
  devDirectorTitle      String?

  // Organization Description (separate from mission statement)
  organizationDescription String? @db.Text  // 1000-word limit
  
  // Organizational Capacity
  fullTimeStaff         Int?
  partTimeStaff         Int?
  volunteers            Int?
  boardMembers          Int?
  
  // Financial
  annualBudget          Decimal? @db.Decimal(12, 2)
  fiscalYearEnd         String?  // e.g., "December 31"
  
  // Form 990 Data (extracted/entered)
  form990Year           Int?
  form990TotalRevenue   Decimal? @db.Decimal(12, 2)
  form990TotalExpenses  Decimal? @db.Decimal(12, 2)
  form990NetAssets      Decimal? @db.Decimal(12, 2)
  form990ProgramExpenses Decimal? @db.Decimal(12, 2)
  form990AdminExpenses  Decimal? @db.Decimal(12, 2)
  form990FundraisingExpenses Decimal? @db.Decimal(12, 2)
  
  // Profile Review Per Cycle
  profileLastReviewedAt       DateTime?
  profileLastReviewedForCycle String?

  // Profile Completion
  profileComplete       Boolean  @default(false)
  profileCompletedAt    DateTime?
  
  // Relationships
  users                 User[]
  documents             Document[]
  applications          Application[]
  lois                  LetterOfInterest[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([ein])
  @@index([legalName])
}

// ============================================
// DOCUMENT LIBRARY
// ============================================

model Document {
  id                    String       @id @default(cuid())

  // Ownership
  organizationId        String?
  organization          Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  applicationId         String?
  application           Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  loiId                 String?
  loi                   LetterOfInterest? @relation(fields: [loiId], references: [id], onDelete: Cascade)

  // Document Info
  scope                 DocumentScope
  type                  DocumentType
  name                  String       // User-friendly name
  description           String?

  // File Details
  fileName              String
  fileSize              Int
  mimeType              String
  storageKey            String       // Blob/S3 key
  storageUrl            String       // URL (regenerated for private)

  // Metadata
  documentYear          Int?         // For Form 990, financials
  expiresAt             DateTime?    // For time-sensitive docs

  // Audit
  uploadedById          String       // Clerk user ID
  uploadedByName        String
  uploadedAt            DateTime     @default(now())

  @@index([organizationId])
  @@index([applicationId])
  @@index([loiId])
  @@index([type])
}

// ============================================
// LETTER OF INTEREST (LOI) MODEL
// ============================================

model LetterOfInterest {
  id                    String       @id @default(cuid())

  // Relationships
  organizationId        String
  organization          Organization @relation(fields: [organizationId], references: [id])
  cycleConfigId         String
  cycleConfig           GrantCycleConfig @relation(fields: [cycleConfigId], references: [id])

  // Status tracking
  status                LOIStatus    @default(DRAFT)

  // Contact Information (from LOI document)
  primaryContactName    String?
  primaryContactTitle   String?
  primaryContactPhone   String?
  primaryContactEmail   String?
  executiveDirector     String?

  // Foundation Focus (single selection)
  focusArea             FocusArea?

  // Expenditure Type
  expenditureType       ExpenditureType?

  // Project Questions
  isNewProject          Boolean?
  newProjectExplanation String?      @db.Text
  isCapacityIncrease    Boolean?
  capacityExplanation   String?      @db.Text

  // Project Details
  projectTitle          String?
  projectDescription    String?      @db.Text  // 500 word max
  projectGoals          String?      @db.Text  // 500 word max

  // Administrator Synopsis
  adminSynopsis         String?      @db.Text
  adminSynopsisBy       String?
  adminSynopsisAt       DateTime?

  // Financial Information
  totalProjectAmount    Decimal?     @db.Decimal(12, 2)
  grantRequestAmount    Decimal?     @db.Decimal(12, 2)
  percentOfProject      Decimal?     @db.Decimal(5, 2)  // Auto-calculated
  budgetOutline         String?      @db.Text  // 250 word max

  // Photos (1-3 jpgs) - via Document relation
  documents             Document[]

  // Admin Review
  reviewedById          String?
  reviewedByName        String?
  reviewedAt            DateTime?
  reviewNotes           String?      @db.Text
  decisionReason        String?      @db.Text

  // Multi-step form tracking
  currentStep           Int          @default(1)
  completedSteps        Int[]        @default([])
  lastSavedAt           DateTime?

  // Batch Release
  notificationSent      Boolean      @default(false)
  notificationSentAt    DateTime?

  // Submission tracking
  submittedAt           DateTime?
  submittedById         String?
  submittedByName       String?

  // Link to resulting application (if approved)
  application           Application?

  // Status history for LOI
  statusHistory         LOIStatusHistory[]

  // Timestamps
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  @@unique([organizationId, cycleConfigId])  // One LOI per org per cycle
  @@index([status])
  @@index([cycleConfigId])
  @@index([organizationId])
}

model LOIStatusHistory {
  id                    String       @id @default(cuid())
  loiId                 String
  loi                   LetterOfInterest @relation(fields: [loiId], references: [id], onDelete: Cascade)

  previousStatus        LOIStatus?
  newStatus             LOIStatus
  changedById           String?
  changedByName         String?
  reason                String?      @db.Text

  createdAt             DateTime     @default(now())

  @@index([loiId])
}

// ============================================
// APPLICATION MODELS
// ============================================

model Application {
  id                    String            @id @default(cuid())

  // Relationships
  organizationId        String
  organization          Organization      @relation(fields: [organizationId], references: [id])

  // Link back to LOI (required - applications created from approved LOIs)
  loiId                 String?           @unique
  loi                   LetterOfInterest? @relation(fields: [loiId], references: [id])

  // Application Metadata
  grantCycle            GrantCycle
  cycleYear             Int
  status                ApplicationStatus @default(DRAFT)
  submittedAt           DateTime?

  // Submission tracking
  submittedById         String?           // Clerk user ID
  submittedByName       String?

  // --- Organization Info (displayed for reference, inherited from profile) ---
  missionStatement      String?           @db.Text
  servicesDescription   String?           @db.Text

  // --- Project Information (from Full Application) ---
  focusArea             FocusArea?
  geographyServed       GeographyServed[] @default([])
  geographyOther        String?           // If "OTHER" is selected
  projectCategory       ExpenditureType?

  // Project Details
  projectTitle          String?
  projectDescription    String?           @db.Text
  projectGoals          String?           @db.Text
  targetPopulation      String?           @db.Text
  geographicArea        String?
  projectStartDate      DateTime?
  projectEndDate        DateTime?
  timelineDetails       String?           @db.Text  // Optional narrative after dates

  // --- Proposed Project Details (Full Application specific) ---
  proposedProject       String?           @db.Text  // Describe action to be funded, alignment to HFF mission
  proposedExpenditures  String?           @db.Text  // How grant funds will be spent
  statementOfNeed       String?           @db.Text  // Need or opportunity addressed
  clientDemographic     String?           @db.Text  // Demographics served

  // Funding Request
  amountRequested       Decimal?          @db.Decimal(10, 2)
  totalProjectBudget    Decimal?          @db.Decimal(10, 2)
  percentageRequested   Decimal?          @db.Decimal(5, 2) // Auto-calculated
  otherFundingSources   String?           @db.Text
  confirmedFundingSources Json?           // [{name: string, amount: number}]
  pendingFundingSources   Json?           // [{name: string, amount: number}]
  previousHFFGrants     String?           @db.Text
  noGrantsReceived      Boolean           @default(false)
  previousHFFGrantsData Json?             // [{date: string, amount: number, projectTitle: string}] (up to 3)

  // Administrator Synopsis
  adminSynopsis         String?           @db.Text
  adminSynopsisBy       String?
  adminSynopsisAt       DateTime?

  // Impact & Outcomes
  expectedOutcomes      String?           @db.Text
  measurementPlan       String?           @db.Text
  sustainabilityPlan    String?           @db.Text
  beneficiariesCount    Int?

  // Children Focus (Mission Alignment)
  childrenServed        Int?
  ageRangeStart         Int?
  ageRangeEnd           Int?
  povertyIndicators     String?           @db.Text
  schoolsServed         String?           @db.Text

  // Board of Directors
  boardOfDirectors      String?           @db.Text  // List with affiliations
  boardMembers          Json?             // [{name: string, title: string, affiliation: string}]

  // Demographics (Children in Poverty metrics)
  clientDemographicDescription String?    @db.Text
  childrenInPovertyImpacted    Int?
  totalChildrenServedAnnually  Int?
  povertyPercentage            Decimal?   @db.Decimal(5,2)

  // Agreement & Signature
  agreementAccepted     Boolean           @default(false)
  signatureName         String?
  signatureTitle        String?
  signatureDate         DateTime?

  // Budget Breakdown (JSON for flexibility)
  budgetBreakdown       Json?

  // Application Progress (for multi-step form)
  currentStep           Int               @default(1)
  completedSteps        Int[]             @default([])
  lastSavedAt           DateTime?

  // AI-Generated Content
  aiSummary             String?           @db.Text
  aiSummaryGeneratedAt  DateTime?
  aiMissionAlignment    Int?              // 1-100 score
  aiBudgetAnalysis      Json?
  aiStrengths           String[]          @default([])
  aiConcerns            String[]          @default([])
  aiQuestions           String[]          @default([])

  // Related Data
  documents             Document[]
  notes                 Note[]
  statusHistory         StatusHistory[]
  communications        Communication[]
  votes                 Vote[]
  highlights            Highlight[]
  budgetAssessments     BudgetAssessment[]

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([status])
  @@index([grantCycle, cycleYear])
  @@index([organizationId])
  @@index([submittedAt])
  @@index([loiId])
}

model Note {
  id                    String      @id @default(cuid())
  applicationId         String
  application           Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  authorId              String      // Clerk user ID
  authorName            String
  content               String      @db.Text
  isPrivate             Boolean     @default(true) // Private = staff only
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([applicationId])
}

model StatusHistory {
  id                    String            @id @default(cuid())
  applicationId         String
  application           Application       @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  previousStatus        ApplicationStatus?
  newStatus             ApplicationStatus
  changedById           String?           // Clerk user ID (null for system)
  changedByName         String?
  reason                String?           @db.Text
  
  createdAt             DateTime          @default(now())
  
  @@index([applicationId])
}

model Communication {
  id                    String      @id @default(cuid())
  applicationId         String
  application           Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  direction             String      // 'inbound' | 'outbound'
  type                  String      // 'email' | 'portal_message' | 'system'
  subject               String?
  content               String      @db.Text
  
  sentById              String?     // Clerk user ID
  sentByName            String?
  sentAt                DateTime    @default(now())
  
  // For info requests
  responseRequired      Boolean     @default(false)
  responseDeadline      DateTime?
  responseReceivedAt    DateTime?
  responseContent       String?     @db.Text
  
  @@index([applicationId])
  @@index([responseRequired, responseReceivedAt])
}

model Vote {
  id                    String      @id @default(cuid())
  applicationId         String
  application           Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  reviewerId            String      // Clerk user ID
  reviewerName          String
  vote                  String      // 'APPROVE' | 'DECLINE' | 'ABSTAIN'
  reasoning             String?     @db.Text
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@unique([applicationId, reviewerId])
  @@index([applicationId])
}

// ============================================
// SYSTEM CONFIGURATION
// ============================================

model GrantCycleConfig {
  id                    String     @id @default(cuid())
  cycle                 GrantCycle
  year                  Int

  // Dates
  loiOpenDate           DateTime?
  loiDeadline           DateTime
  loiReviewDeadline     DateTime?  // When admin should finish LOI reviews
  fullAppOpenDate       DateTime?  // When approved LOIs can start full app
  fullAppDeadline       DateTime?
  reviewStartDate       DateTime?
  decisionDate          DateTime?

  // Status flags
  isActive              Boolean    @default(false)
  acceptingLOIs         Boolean    @default(false)  // LOI submission window
  acceptingApplications Boolean    @default(false)  // Full app submission window

  // Settings
  maxRequestAmount      Decimal?   @db.Decimal(10, 2)

  // Relationships
  lois                  LetterOfInterest[]

  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt

  @@unique([cycle, year])
}

model EmailTemplate {
  id                    String   @id @default(cuid())
  name                  String   @unique
  subject               String
  body                  String   @db.Text
  variables             String[] // Available merge fields
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model AuditLog {
  id                    String   @id @default(cuid())
  userId                String?  // Clerk user ID
  userEmail             String?
  userType              String?  // 'applicant' | 'reviewer' | 'admin' | 'system'
  action                String
  entityType            String
  entityId              String?
  details               Json?
  ipAddress             String?
  
  createdAt             DateTime @default(now())
  
  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
}

model FoundationSettings {
  id                    String   @id @default(cuid())
  
  // Foundation Identity
  foundationName        String
  tagline               String?
  
  // Mission & Purpose
  missionStatement      String   @db.Text
  visionStatement       String?  @db.Text
  focusAreas            String[] @default([])
  
  // Contact Information
  primaryEmail          String
  phoneNumber           String
  websiteUrl            String?
  
  // Physical Address
  streetAddress         String
  addressLine2          String?
  city                  String
  state                 String
  zipCode               String
  
  // Social Media (optional)
  facebookUrl           String?
  twitterUrl            String?
  linkedinUrl           String?

  // AI Scoring Configuration
  aiScoringPriorities   String[]  @default([])
  aiGeographicFocus     String?   @db.Text
  aiCustomGuidance      String?   @db.Text
  aiTemperature         Float     @default(0.3)
  aiMaxTokens           Int       @default(2000)

  // Settings Metadata
  updatedAt             DateTime @updatedAt
  updatedById           String?  // Clerk user ID
  updatedByName         String?

  @@index([id])
}

// ============================================
// TEXT HIGHLIGHTING (Reviewer Feature)
// ============================================

model Highlight {
  id                    String      @id @default(cuid())
  applicationId         String
  application           Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  fieldName             String      // "projectDescription", "projectGoals", etc.
  startOffset           Int
  endOffset             Int
  color                 String      @default("yellow")
  comment               String?     @db.Text

  createdById           String
  createdByName         String
  createdAt             DateTime    @default(now())

  @@index([applicationId])
}

// ============================================
// BUDGET ASSESSMENT SCORING (Reviewer Feature)
// ============================================

model BudgetAssessment {
  id                    String      @id @default(cuid())
  applicationId         String
  application           Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  reviewerId            String
  reviewerName          String

  budgetReasonableness  Int?        // 1-5 score
  costEfficiency        Int?        // 1-5 score
  budgetDetail          Int?        // 1-5 score
  sustainability        Int?        // 1-5 score
  compositeScore        Float?      // Weighted average

  notes                 String?     @db.Text

  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  @@unique([applicationId, reviewerId])
  @@index([applicationId])
}
